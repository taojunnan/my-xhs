function SekiroClient(e){if(this.wsURL=e,this.handlers={},this.socket={},!e)throw new Error("wsURL can not be empty!!");this.webSocketFactory=this.resolveWebSocketFactory(),this.connect()}SekiroClient.prototype.resolveWebSocketFactory=function(){if("object"==typeof window){var e=window.WebSocket?window.WebSocket:window.MozWebSocket;return function(t){function o(t){this.mSocket=new e(t)}return o.prototype.close=function(){this.mSocket.close()},o.prototype.onmessage=function(e){this.mSocket.onmessage=e},o.prototype.onopen=function(e){this.mSocket.onopen=e},o.prototype.onclose=function(e){this.mSocket.onclose=e},o.prototype.send=function(e){this.mSocket.send(e)},new o(t)}}if("object"==typeof weex)try{console.log("test webSocket for weex");var t=weex.requireModule("webSocket");return console.log("find webSocket for weex:"+t),function(e){try{t.close()}catch(e){}return t.WebSocket(e,""),t}}catch(e){console.log(e)}if("object"==typeof WebSocket)return function(t){return new e(t)};throw new Error("the environment do not support websocket")},SekiroClient.prototype.connect=function(){console.log("sekiro: begin of connect to wsURL: "+this.wsURL);var e=this;try{this.socket=this.webSocketFactory(this.wsURL)}catch(t){return console.log("sekiro: create connection failed,reconnect after 2s:"+t),void setTimeout((function(){e.connect()}),2e3)}this.socket.onmessage((function(t){e.handleSekiroRequest(t.data)})),this.socket.onopen((function(e){console.log("sekiro: open a sekiro client connection")})),this.socket.onclose((function(t){console.log("sekiro: disconnected ,reconnection after 2s"),setTimeout((function(){e.connect()}),2e3)}))},SekiroClient.prototype.handleSekiroRequest=function(e){console.log("receive sekiro request: "+e);var t=JSON.parse(e),o=t.__sekiro_seq__;if(t.action){var n=t.action;if(this.handlers[n]){var s=this.handlers[n],r=this;try{s(t,(function(e){try{r.sendSuccess(o,e)}catch(e){r.sendFailed(o,"e:"+e)}}),(function(e){r.sendFailed(o,e)}))}catch(e){console.log("error: "+e),r.sendFailed(o,":"+e)}}else this.sendFailed(o,"no action handler: "+n+" defined")}else this.sendFailed(o,"need request param {action}")},SekiroClient.prototype.sendSuccess=function(e,t){var o;if("string"==typeof t)try{o=JSON.parse(t)}catch(e){(o={}).data=t}else"object"==typeof t?o=t:(o={}).data=t;(Array.isArray(o)||"string"==typeof o)&&(o={data:o,code:0}),o.code?o.code=0:(o.status,o.status=0),o.__sekiro_seq__=e;var n=JSON.stringify(o);console.log("response :"+n),this.socket.send(n)},SekiroClient.prototype.sendFailed=function(e,t){"string"!=typeof t&&(t=JSON.stringify(t));var o={};o.message=t,o.status=-1,o.__sekiro_seq__=e;var n=JSON.stringify(o);console.log("sekiro: response :"+n),this.socket.send(n)},SekiroClient.prototype.registerAction=function(e,t){if("string"!=typeof e)throw new Error("an action must be string");if("function"!=typeof t)throw new Error("a handler must be function");return console.log("sekiro: register action: "+e),this.handlers[e]=t,this};const GROUP_NAME="wpsxhs",MY_MODULE_NAME="wpsmodule",client=new SekiroClient("ws://127.0.0.1:5612/business/register?group=wpsxhs&clientId="+Math.random());async function hookjs(){return new Promise(((e,t)=>{let o=null;if(Array.from(document.head.getElementsByTagName("script")).forEach((e=>{e.src&&e.src.includes("runtime-main")&&(console.log("Found script with runtime-main:",e.src),o=e)})),!o)return t("Failed to find runtime-main script");const n=o.src;fetch(n).then((e=>e.text())).then((t=>{const o=/function\s+(\w+)\s*\(/g.exec(t);let n="u";o&&o.length>1&&(n=o[1],console.log("matched function name: ",n));const s=t.replace('"use strict";',`"use strict";window.myxhs = ${n};`),r=document.createElement("script");r.textContent=s,document.head.appendChild(r),e()})).catch((e=>{t("runtime-main fetch error")}))}))}function findApiKey(){for(let e of webpackChunkxhs_pc_web)if(e[1])for(let t in e[1]){if(e[1][t].toString().indexOf("【web】- homefeed")>-1)return console.log("key",t),t}}function getUrlMap(e){const t={};return['"/api/sns/web/v1/homefeed"','"/api/sns/web/v1/feed"','"/api/sns/web/v2/comment/page"','"/api/sns/web/v1/search/notes"','"/api/sns/web/v1/search/onebox"'].forEach((o=>{const n=o.replace(/"/g,"").replace("/api/sns/web/v1/","").replace("/api/sns/web/v2/","");for(let s in e){e[s].toString().indexOf(o)>-1&&(t[n]=s)}})),t}function injectMyModule(){myxhs.m[MY_MODULE_NAME]=(e,t,o)=>{const n=findApiKey()||27171,s=o(n);console.log(n);const r=getUrlMap(s);console.log(r),t.getNextPageData=(e=35)=>{const t={cursor_score:localStorage.getItem("HOME_FEED_CURSOR_SCORE")||"",num:20,refresh_type:3,note_index:e,unread_begin_note_id:"",unread_end_note_id:"",unread_note_count:0,category:"homefeed_recommend",search_key:"",need_num:10,image_formats:["jpg","webp","avif"],need_filter_image:!1};return s[r.homefeed](t)},t.getNoteDetail=e=>{const t={source_note_id:e,image_formats:["jpg","webp","avif"],extra:{need_body_topic:"1"}};return s[r.feed](t)},t.getComment=e=>{const t={noteId:e,cursor:"",topCommentId:"",imageFormats:"jpg,webp,avif"};return s[r["comment/page"]]({params:t})},t.search=e=>{const t={keyword:e,search_id:"2dh0sp2hw93sh2rkkrear",biz_type:"web_search_user",request_id:"2075357442-1720504968723"};s[r["search/onebox"]](t);const o={keyword:e,page:1,page_size:20,search_id:"2dh0sp2hw93sh2rkkrear",sort:"general",note_type:0,ext_flags:[],image_formats:["jpg","webp","avif"]};return s[r["search/notes"]](o)}}}function registerAction(){const e=myxhs(MY_MODULE_NAME);client.registerAction("nextPage",((t,o,n)=>{const s=t.index;e.getNextPageData(Number(s)).then(o)})),client.registerAction("noteDetail",((t,o,n)=>{const s=t.id;e.getNoteDetail(s).then(o)})),client.registerAction("comment",((t,o,n)=>{const s=t.id;e.getComment(s).then(o)})),client.registerAction("search",((t,o,n)=>{const s=t.keyword;e.search(s).then(o).catch(o)}))}function checkIsReady(){const e=myxhs(MY_MODULE_NAME);return!!(e.getNextPageData&&e.getNoteDetail&&e.getComment)}async function init(){try{await hookjs(),injectMyModule(),registerAction(),checkIsReady()?alert("小红书网页端已准备就绪"):alert("未知错误，请稍后再试")}catch(e){alert(e)}}init();